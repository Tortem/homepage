name: deploy to kubernetes cluster
on:
  push:
    branches:
      - main

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      digest: ${{ steps.docker_build.outputs.digest }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        id: docker_build
        with:
          context: .
          push: true
          tags: ghcr.io/tortem/homepage:latest
          file: ./Dockerfile

  helm:
    runs-on: ubuntu-latest
    needs: build-and-push
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Log in to GitHub Container Registry for Helm
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Package Helm chart
        run: |
          CURRENT_VERSION=$(yq eval '.version' ./helm/Chart.yaml)
          MAJOR_MINOR=$(echo $CURRENT_VERSION | sed 's/\.[0-9]*$//')
          
          # Use commit timestamp as patch version (format: YYYYMMDDHHMM)
          PATCH=$(git log -1 --format="%cd" --date=format:"%Y%m%d%H%M")
          
          CHART_VERSION="${MAJOR_MINOR}.${PATCH}"
          echo "Chart version: $CHART_VERSION"
          
          # Update chart version in Chart.yaml
          yq eval ".version = \"$CHART_VERSION\"" -i ./helm/Chart.yaml
          
          # Update the image digest in values.yaml
          echo "Using digest: ${{ needs.build-and-push.outputs.digest }}"
          yq eval '.image.digest = "${{ needs.build-and-push.outputs.digest }}"' -i ./helm/values.yaml
          yq eval 'del(.image.tag)' -i ./helm/values.yaml
          helm package ./helm --destination .

      - name: Push Helm chart to GHCR
        run: |
          helm registry login ghcr.io -u ${{ github.actor }} --password ${{ secrets.GITHUB_TOKEN }}
          helm push homepage-*.tgz oci://ghcr.io/tortem/charts